name: Sync Components

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      component:
        description: 'Specific component to sync (leave empty for all)'
        required: false
        type: choice
        options:
        - frankenstein-db
        - ai-scraper-vm
        - ai-scraper-dashboard
        - all
      force:
        description: 'Force sync even if no changes'
        required: false
        default: false
        type: boolean

env:
  COMPONENTS: frankenstein-db ai-scraper-vm ai-scraper-dashboard

jobs:
  sync-components:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout monorepo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0

    - name: Set up Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Sync specific component (if requested)
      if: github.event.inputs.component && github.event.inputs.component != 'all'
      run: |
        echo "ðŸ”„ Syncing specific component: ${{ github.event.inputs.component }}"
        ./sync-components.sh --component ${{ github.event.inputs.component }}

    - name: Sync all components
      if: github.event.inputs.component == '' || github.event.inputs.component == 'all' || github.event_name == 'schedule'
      run: |
        echo "ðŸ”„ Syncing all components..."
        ./sync-components.sh

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected:"
          git diff --name-only | head -10
          if [ "$(git diff --name-only | wc -l)" -gt 10 ]; then
            echo "... and $(($(git diff --name-only | wc -l) - 10)) more files"
          fi
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force == true
      run: |
        echo "ðŸ’¾ Committing synced changes..."

        # Add all changes
        git add .

        # Create detailed commit message
        COMMIT_MSG="ðŸ”„ Auto-sync components

$(git diff --cached --name-only | sed 's/^/- /' | head -20)
$(if [ "$(git diff --cached --name-only | wc -l)" -gt 20 ]; then
  echo ""
  echo "And $(($(git diff --cached --name-only | wc -l) - 20)) more files..."
fi)

Synced from standalone repositories:
- frankenstein-db
- ai-scraper-vm
- ai-scraper-dashboard

This commit was automatically generated by the component sync workflow."

        # Commit changes
        git commit -m "$COMMIT_MSG"

        # Push to main branch
        git push origin main

        echo "âœ… Changes committed and pushed"

    - name: Create sync report
      run: |
        echo "## ðŸ”„ Component Sync Report" > sync_report.md
        echo "- **Timestamp:** $(date)" >> sync_report.md
        echo "- **Trigger:** ${{ github.event_name }}" >> sync_report.md
        echo "- **Component:** ${{ github.event.inputs.component || 'all' }}" >> sync_report.md
        echo "- **Changes:** ${{ steps.changes.outputs.has_changes == 'true' && 'Yes' || 'No' }}" >> sync_report.md
        echo "" >> sync_report.md
        echo "### Synced Components" >> sync_report.md
        echo "- âœ… frankenstein-db" >> sync_report.md
        echo "- âœ… ai-scraper-vm" >> sync_report.md
        echo "- âœ… ai-scraper-dashboard" >> sync_report.md
        echo "" >> sync_report.md
        if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
          echo "### Files Changed" >> sync_report.md
          git diff --cached --name-only | head -20 | sed 's/^/- /' >> sync_report.md
          if [ "$(git diff --cached --name-only | wc -l)" -gt 20 ]; then
            echo "- ... and $(($(git diff --cached --name-only | wc -l) - 20)) more files" >> sync_report.md
          fi
        fi
        cat sync_report.md

    - name: Upload sync report
      uses: actions/upload-artifact@v3
      with:
        name: sync-report
        path: sync_report.md

    - name: Notify sync completion
      run: |
        if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
          MESSAGE="ðŸ”„ AI Scraper components synced successfully! $(git diff --cached --name-only | wc -l) files updated."
        else
          MESSAGE="ðŸ”„ AI Scraper components sync completed - no changes detected."
        fi

        # Slack notification (if webhook configured)
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK }} || true